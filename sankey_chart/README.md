# Preview

![Screen Shot 2023-03-16 at 12 16 23 PM](https://user-images.githubusercontent.com/124118181/225521638-9898c83d-b45e-4ca8-ba80-9a80d1f60d5b.png)

# Sample Data
```json

[
  {
    "source": "Agricultural 'waste'",
    "target": "Bio-conversion",
    "value": 124.729
  },
  {
    "source": "Bio-conversion",
    "target": "Liquid",
    "value": 0.597
  },
  {
    "source": "Bio-conversion",
    "target": "Losses",
    "value": 26.862
  },
  {
    "source": "Bio-conversion",
    "target": "Solid",
    "value": 280.322
  },
  {
    "source": "Bio-conversion",
    "target": "Gas",
    "value": 81.144
  },
  {
    "source": "Biofuel imports",
    "target": "Liquid",
    "value": 35
  },
  {
    "source": "Biomass imports",
    "target": "Solid",
    "value": 35
  },
  {
    "source": "Coal imports",
    "target": "Coal",
    "value": 11.606
  },
  {
    "source": "Coal reserves",
    "target": "Coal",
    "value": 63.965
  },
  {
    "source": "Coal",
    "target": "Solid",
    "value": 75.571
  },
  {
    "source": "District heating",
    "target": "Industry",
    "value": 10.639
  },
  {
    "source": "District heating",
    "target": "Heating and cooling - commercial",
    "value": 22.505
  },
  {
    "source": "District heating",
    "target": "Heating and cooling - homes",
    "value": 46.184
  },
  {
    "source": "Electricity grid",
    "target": "Over generation / exports",
    "value": 104.453
  },
  {
    "source": "Electricity grid",
    "target": "Heating and cooling - homes",
    "value": 113.726
  },
  {
    "source": "Electricity grid",
    "target": "H2 conversion",
    "value": 27.14
  },
  {
    "source": "Electricity grid",
    "target": "Industry",
    "value": 342.165
  },
  {
    "source": "Electricity grid",
    "target": "Road transport",
    "value": 37.797
  },
  {
    "source": "Electricity grid",
    "target": "Agriculture",
    "value": 4.412
  },
  {
    "source": "Electricity grid",
    "target": "Heating and cooling - commercial",
    "value": 40.858
  },
  {
    "source": "Electricity grid",
    "target": "Losses",
    "value": 56.691
  },
  {
    "source": "Electricity grid",
    "target": "Rail transport",
    "value": 7.863
  },
  {
    "source": "Electricity grid",
    "target": "Lighting & appliances - commercial",
    "value": 90.008
  },
  {
    "source": "Electricity grid",
    "target": "Lighting & appliances - homes",
    "value": 93.494
  },
  {
    "source": "Gas imports",
    "target": "Ngas",
    "value": 40.719
  },
  {
    "source": "Gas reserves",
    "target": "Ngas",
    "value": 82.233
  },
  {
    "source": "Gas",
    "target": "Heating and cooling - commercial",
    "value": 0.129
  },
  {
    "source": "Gas",
    "target": "Losses",
    "value": 1.401
  },
  {
    "source": "Gas",
    "target": "Thermal generation",
    "value": 151.891
  },
  {
    "source": "Gas",
    "target": "Agriculture",
    "value": 2.096
  },
  {
    "source": "Gas",
    "target": "Industry",
    "value": 48.58
  },
  {
    "source": "Geothermal",
    "target": "Electricity grid",
    "value": 7.013
  },
  {
    "source": "H2 conversion",
    "target": "H2",
    "value": 20.897
  },
  {
    "source": "H2 conversion",
    "target": "Losses",
    "value": 6.242
  },
  {
    "source": "H2",
    "target": "Road transport",
    "value": 20.897
  },
  {
    "source": "Hydro",
    "target": "Electricity grid",
    "value": 6.995
  },
  {
    "source": "Liquid",
    "target": "Industry",
    "value": 121.066
  },
  {
    "source": "Liquid",
    "target": "International shipping",
    "value": 128.69
  },
  {
    "source": "Liquid",
    "target": "Road transport",
    "value": 135.835
  },
  {
    "source": "Liquid",
    "target": "Domestic aviation",
    "value": 14.458
  },
  {
    "source": "Liquid",
    "target": "International aviation",
    "value": 206.267
  },
  {
    "source": "Liquid",
    "target": "Agriculture",
    "value": 3.64
  },
  {
    "source": "Liquid",
    "target": "National navigation",
    "value": 33.218
  },
  {
    "source": "Liquid",
    "target": "Rail transport",
    "value": 4.413
  },
  {
    "source": "Marine algae",
    "target": "Bio-conversion",
    "value": 4.375
  },
  {
    "source": "Ngas",
    "target": "Gas",
    "value": 122.952
  },
  {
    "source": "Nuclear",
    "target": "Thermal generation",
    "value": 839.978
  },
  {
    "source": "Oil imports",
    "target": "Oil",
    "value": 504.287
  },
  {
    "source": "Oil reserves",
    "target": "Oil",
    "value": 107.703
  },
  {
    "source": "Oil",
    "target": "Liquid",
    "value": 611.99
  },
  {
    "source": "Other waste",
    "target": "Solid",
    "value": 56.587
  },
  {
    "source": "Other waste",
    "target": "Bio-conversion",
    "value": 77.81
  },
  {
    "source": "Pumped heat",
    "target": "Heating and cooling - homes",
    "value": 193.026
  },
  {
    "source": "Pumped heat",
    "target": "Heating and cooling - commercial",
    "value": 70.672
  },
  {
    "source": "Solar PV",
    "target": "Electricity grid",
    "value": 59.901
  },
  {
    "source": "Solar Thermal",
    "target": "Heating and cooling - homes",
    "value": 19.263
  },
  {
    "source": "Solar",
    "target": "Solar Thermal",
    "value": 19.263
  },
  {
    "source": "Solar",
    "target": "Solar PV",
    "value": 59.901
  },
  {
    "source": "Solid",
    "target": "Agriculture",
    "value": 0.882
  },
  {
    "source": "Solid",
    "target": "Thermal generation",
    "value": 400.12
  },
  {
    "source": "Solid",
    "target": "Industry",
    "value": 46.477
  },
  {
    "source": "Thermal generation",
    "target": "Electricity grid",
    "value": 525.531
  },
  {
    "source": "Thermal generation",
    "target": "Losses",
    "value": 787.129
  },
  {
    "source": "Thermal generation",
    "target": "District heating",
    "value": 79.329
  },
  {
    "source": "Tidal",
    "target": "Electricity grid",
    "value": 9.452
  },
  {
    "source": "UK land based bioenergy",
    "target": "Bio-conversion",
    "value": 182.01
  },
  {
    "source": "Wave",
    "target": "Electricity grid",
    "value": 19.013
  },
  {
    "source": "Wind",
    "target": "Electricity grid",
    "value": 289.366
  }
]

```

# AML Template

```javascript


CustomChart {
  fields {
    field source {
      type: "dimension"
      label: "Source Node"
      data_type: "string"
    }
    field target {
      type: "dimension"
      label: "Target Node"
      data_type: "string"
    }
    field volume {
      type: "dimension"
      label: "Volume for link from Source-Target"
      data_type: "number"
    }
  }
  options {
    option node_align {
      label: "Node Align"
      type: "select"
      options: ["justify", "left", "right", "center"]
      default_value: "justify"
    }
    option node_width {
      label: "Node Width"
      type: "number-input"
      default_value: 15
    }
    option node_padding {
      label: "Node Padding"
      type: "number-input"
      default_value: 10
    }
    option margin_top {
      label: "Margin Top"
      type: "number-input"
      default_value: 10
    }
    option margin_left {
      label: "Margin Left"
      type: "number-input"
      default_value: 10
    }
    option margin_right {
      label: "Margin right"
      type: "number-input"
      default_value: 10
    }
    option margin_bottom {
      label: "Margin bottom"
      type: "number-input"
      default_value: 10
    }
  }
  template: @vgl
  {
    "$schema": "https://vega.github.io/schema/vega/v5.json",
    "width": 1000,
    "height": 600,
    "autosize": "none",
    "data": [
      {
        "name": "table",
        "values": @{values}
      },
      {
        "name": "nodesAndLinks",
        "source": "table",
        "transform": [
          {
            "type": "formula",
            "expr": "width",
            "as": "containerWidth"
          },
          {
            "type": "formula",
            "expr": "height",
            "as": "containerHeight"
          },
          {
            "type": "sankey",
            "source": "datum['@{fields.source.name}']",
            "target": "datum['@{fields.target.name}']",
            "volume": "datum['@{fields.volume.name}']",
            "nodeAlign": @{options.node_align.value},
            "nodeWidth": @{options.node_width.value},
            "nodePadding": @{options.node_padding.value},
            "marginTop": @{options.margin_top.value},
            "marginRight": @{options.margin_right.value},
            "marginBottom": @{options.margin_bottom.value},
            "marginLeft": @{options.margin_left.value}
          },
          {
            "type": "formula",
            "expr": "datum.source.id",
            "as": "sourceId"
          },
          {
            "type": "formula",
            "expr": "datum.target.id",
            "as": "targetId"
          }
        ]
      },
      {
        "name": "links",
        "source": "nodesAndLinks",
        "transform": [
          {
            "type": "linkpath",
            "orient": "horizontal",
            "shape": "diagonal",
            "sourceY": {
              "expr": "datum.y0"
            },
            "sourceX": {
              "expr": "datum.source.x1"
            },
            "targetY": {
              "expr": "datum.y1"
            },
            "targetX": {
              "expr": "datum.target.x0"
            },
            "as": "path"
          },
          {
            "type": "formula",
            "expr": "datum.width",
            "as": "linkWidth"
          }
        ]
      },
      {
        "name": "extractedNode",
        "source": "nodesAndLinks",
        "transform": [
          {
            "type": "formula",
            "expr": "datum.source.id",
            "as": "sourceId"
          },
          {
            "type": "formula",
            "expr": "datum.source.x0",
            "as": "sourceX0"
          },
          {
            "type": "formula",
            "expr": "datum.source.x1",
            "as": "sourceX1"
          },
          {
            "type": "formula",
            "expr": "datum.source.y0",
            "as": "sourceY0"
          },
          {
            "type": "formula",
            "expr": "datum.source.y1",
            "as": "sourceY1"
          },
          {
            "type": "formula",
            "expr": "(datum.source.y0 + datum.source.y1)/2",
            "as": "sourceYc"
          },
          {
            "type": "formula",
            "expr": "datum.target.id",
            "as": "targetId"
          },
          {
            "type": "formula",
            "expr": "datum.target.x0",
            "as": "targetX0"
          },
          {
            "type": "formula",
            "expr": "datum.target.x1",
            "as": "targetX1"
          },
          {
            "type": "formula",
            "expr": "datum.target.y0",
            "as": "targetY0"
          },
          {
            "type": "formula",
            "expr": "datum.target.y1",
            "as": "targetY1"
          },
          {
            "type": "formula",
            "expr": "(datum.target.y0 + datum.target.y1)/2",
            "as": "targetYc"
          }
        ]
      },
      {
        "name": "uniqueSource",
        "source": "extractedNode",
        "transform": [
          {
            "type": "aggregate",
            "groupby": [
              "sourceId",
              "sourceX0",
              "sourceX1",
              "sourceY0",
              "sourceY1",
              "sourceYc"
            ]
          }
        ]
      },
      {
        "name": "uniqueTarget",
        "source": "extractedNode",
        "transform": [
          {
            "type": "aggregate",
            "groupby": [
              "targetId",
              "targetX0",
              "targetX1",
              "targetY0",
              "targetY1",
              "targetYc"
            ]
          }
        ]
      }
    ],
    "signals": [
      {
        "name": "width",
        "init": "(containerSize()[0])",
        "on": [
          {
            "update": "(containerSize()[0])",
            "events": "window:resize"
          }
        ]
      },
      {
        "name": "height",
        "init": "(containerSize()[1])",
        "on": [
          {
            "update": "(containerSize()[1])",
            "events": "window:resize"
          }
        ]
      }
    ],
    "scales": [
      {
        "name": "sourceColor",
        "type": "ordinal",
        "range": "category",
        "domain": {
          "data": "nodesAndLinks",
          "field": "sourceId"
        }
      },
      {
        "name": "targetColor",
        "type": "ordinal",
        "range": "category",
        "domain": {
          "data": "nodesAndLinks",
          "field": "targetId"
        }
      }
    ],
    "marks": [
      {
        "type": "path",
        "name": "edgeMark",
        "from": {
          "data": "links"
        },
        "clip": true,
        "encode": {
          "update": {
            "path": {
              "field": "path"
            },
            "strokeWidth": {
              "field": "linkWidth"
            },
            "stroke": [
              {
                "scale": "sourceColor",
                "field": "sourceId"
              }
            ],
            "strokeOpacity": {
              "value": 0.6
            },
            "tooltip": {
              "signal": "datum.sourceId + ' → ' + datum.targetId + ': ' + datum.value"
            }
          },
          "hover": {
            "strokeOpacity": {
              "value": 1
            }
          }
        }
      },
      {
        "type": "rect",
        "name": "targetMark",
        "from": {
          "data": "uniqueTarget"
        },
        "encode": {
          "update": {
            "x": {
              "field": "targetX0"
            },
            "x2": {
              "field": "targetX1"
            },
            "y": {
              "field": "targetY0"
            },
            "y2": {
              "field": "targetY1"
            },
            "fill": [
              {
                "scale": "targetColor",
                "field": "targetId"
              }
            ],
            "stroke": {
              "value": "#000"
            },
            "strokeWidth": {
              "value": 0.5
            }
          },
          "hover": {
            "strokeWidth": {
              "value": 3
            }
          }
        }
      },
      {
        "type": "rect",
        "name": "sourceMark",
        "from": {
          "data": "uniqueSource"
        },
        "encode": {
          "update": {
            "x": {
              "field": "sourceX0"
            },
            "x2": {
              "field": "sourceX1"
            },
            "y": {
              "field": "sourceY0"
            },
            "y2": {
              "field": "sourceY1"
            },
            "fill": [
              {
                "scale": "sourceColor",
                "field": "sourceId"
              }
            ],
            "stroke": {
              "value": "#000"
            },
            "strokeWidth": {
              "value": 0.5
            }
          },
          "hover": {
            "strokeWidth": {
              "value": 3
            }
          }
        }
      },
      {
        "type": "text",
        "name": "sourceTextMark",
        "from": {
          "data": "uniqueSource"
        },
        "interactive": false,
        "encode": {
          "update": {
            "yc": {
              "field": "sourceYc"
            },
            "x": {
              "signal": "datum.sourceX1 > width / 2 ? datum.sourceX0 - 5 : datum.sourceX1 + 5"
            },
            "align": {
              "signal": "datum.sourceX1 > width / 2 ? 'right' : 'left'"
            },
            "baseline": {
              "value": "middle"
            },
            "fontWeight": {
              "value": "normal"
            },
            "text": {
              "field": "sourceId"
            }
          }
        }
      },
      {
        "type": "text",
        "name": "targetTextMark",
        "from": {
          "data": "uniqueTarget"
        },
        "interactive": false,
        "encode": {
          "update": {
            "yc": {
              "field": "targetYc"
            },
            "x": {
              "signal": "datum.targetX1 > width / 2 ? datum.targetX0 - 5 : datum.targetX1 + 5"
            },
            "align": {
              "signal": "datum.targetX1 > width / 2 ? 'right' : 'left'"
            },
            "baseline": {
              "value": "middle"
            },
            "fontWeight": {
              "value": "normal"
            },
            "text": {
              "field": "targetId"
            }
          }
        }
      }
    ]
  };;
}

```
